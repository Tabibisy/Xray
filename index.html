<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تحليل الصور الطبي من Hyper-Med</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root {
            --primary: #2b5f87;
            --secondary: #4a8db7;
            --accent: #e74c3c;
            --lab-accent: #9b59b6;
            --light: #f0f7ff;
            --dark: #1a3c5a;
            --success: #27ae60;
            --warning: #f39c12;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        header h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .upload-section {
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--light);
        }
        
        .upload-area:hover {
            border-color: var(--secondary);
            background: #e8f4ff;
        }
        
        .upload-area.dragover {
            border-color: var(--secondary);
            background: #e8f4ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 50px;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-types {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .file-name {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .preview-container {
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .preview-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .compression-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4ff;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        
        .analysis-type {
            margin: 25px 0;
        }
        
        .analysis-type h3 {
            margin-bottom: 15px;
            color: var(--dark);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
        }
        
        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .radio-item {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }
        
        .radio-item.xray {
            border-left: 4px solid var(--secondary);
        }
        
        .radio-item.ct {
            border-left: 4px solid var(--accent);
        }
        
        .radio-item.mri {
            border-left: 4px solid #2ecc71;
        }
        
        .radio-item.ecg {
            border-left: 4px solid #f39c12;
        }
        
        .radio-item.lab {
            border-left: 4px solid var(--lab-accent);
        }
        
        .radio-item:hover {
            background: #e1f0ff;
        }
        
        .radio-item.selected {
            border-color: var(--secondary);
            background: #e1f0ff;
        }
        
        .radio-item input {
            margin-left: 5px;
        }
        
        .camera-section {
            margin: 20px 0;
            text-align: center;
        }
        
        .camera-preview {
            margin-top: 15px;
            display: none;
            text-align: center;
        }
        
        .camera-preview video,
        .camera-preview canvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .camera-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 15px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background: var(--primary);
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #3d7ea6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-info {
            background: #3498db;
        }
        
        .btn-info:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .button-icon {
            margin-left: 8px;
            font-size: 18px;
        }
        
        #response {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
            border-right: 5px solid var(--secondary);
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .response-title {
            font-weight: bold;
            color: var(--dark);
        }
        
        .response-actions {
            display: flex;
            gap: 10px;
        }
        
        .analysis-content {
            line-height: 1.8;
        }
        
        .analysis-content h4 {
            margin: 15px 0 8px 0;
            color: var(--primary);
        }
        
        .analysis-content ul {
            padding-right: 20px;
            margin-bottom: 15px;
        }
        
        .analysis-content li {
            margin-bottom: 5px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .radio-group {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 24px;
            }
            
            .content {
                padding: 15px;
            }
            
            .camera-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>نظام تحليل الصور الطبي من Hyper-Med</h1>
            <p>قم بتحميل الصور الطبية أو نتائج التحاليل للحصول على تحليل مفصل باستخدام أحدث تقنيات الذكاء الاصطناعي</p>
        </header>
        
        <div class="content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <p>انقر لتحميل الصورة أو اسحبها وأفلتها هنا</p>
                    <p class="file-types">(JPEG, PNG, DICOM, PDF)</p>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.dicom,.dcm,.pdf" />
                </div>
                
                <div class="file-name" id="fileName"></div>
                
                <div class="preview-container" id="previewContainer">
                    <h4>معاينة الصورة:</h4>
                    <img id="imagePreview" alt="معاينة الصورة" />
                </div>
                
                <div class="compression-info" id="compressionInfo"></div>
            </div>
            
            <div class="camera-section">
                <button id="cameraBtn" class="btn-info">
                    فتح الكاميرا <span class="button-icon">📷</span>
                </button>
                
                <div class="camera-preview" id="cameraPreview">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="camera-controls">
                        <button id="captureBtn" class="btn-success" style="display: none;">
                            التقاط صورة <span class="button-icon">📸</span>
                        </button>
                        <button id="retakeBtn" class="btn-warning" style="display: none;">
                            إعادة التقاط <span class="button-icon">🔄</span>
                        </button>
                        <button id="closeCameraBtn" class="btn-secondary" style="display: none;">
                            إغلاق الكاميرا <span class="button-icon">❌</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="analysis-type">
                <h3>اختر نوع التحليل المطلوب:</h3>
                <div class="radio-group">
                    <label class="radio-item xray">
                        <input type="radio" name="analysisType" value="xray" checked>
                        أشعة X-Ray (عادية)
                    </label>
                    <label class="radio-item ct">
                        <input type="radio" name="analysisType" value="ct">
                        أشعة مقطعية (CT Scan)
                    </label>
                    <label class="radio-item mri">
                        <input type="radio" name="analysisType" value="mri">
                        رنين مغناطيسي (MRI)
                    </label>
                    <label class="radio-item ecg">
                        <input type="radio" name="analysisType" value="ecg">
                        تخطيط القلب (ECG)
                    </label>
                    <label class="radio-item lab">
                        <input type="radio" name="analysisType" value="lab">
                        تحاليل مخبرية
                    </label>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="compressBtn" class="btn-warning" disabled>
                    تقليص حجم الصورة <span class="button-icon">📁</span>
                </button>
                <button id="analyzeBtn" class="btn-primary" disabled>
                    بدء التحليل <span class="button-icon">⚕️</span>
                </button>
            </div>
            
            <div id="response">
                <div class="response-header">
                    <div class="response-title">نتيجة التحليل</div>
                    <div class="response-actions">
                        <button id="copyReportBtn" class="btn-success">
                            نسخ التقرير <span class="button-icon">📋</span>
                        </button>
                    </div>
                </div>
                <div class="analysis-content" id="analysisResult"></div>
            </div>
        </div>
        
        <footer>
            <p>هذا النظام مصمم للمساعدة في التحليل الأولي ولا يغني عن استشارة الطبيب المتخصص</p>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // عناصر DOM
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileName = document.getElementById('fileName');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const compressionInfo = document.getElementById('compressionInfo');
        const compressBtn = document.getElementById('compressBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const response = document.getElementById('response');
        const analysisResult = document.getElementById('analysisResult');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const radioItems = document.querySelectorAll('.radio-item');
        const toast = document.getElementById('toast');
        
        // عناصر الكاميرا الجديدة
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraPreview = document.getElementById('cameraPreview');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        
        // متغيرات التطبيق
        let uploadedFile = null;
        let compressedFile = null;
        let originalSize = 0;
        let compressedSize = 0;
        let stream = null;
        let usingFrontCamera = false; // متغير لتتبع نوع الكاميرا المستخدمة
        
        // تهيئة التطبيق
        function initApp() {
            // إضافة مستمعي الأحداث
            fileInput.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('click', () => fileInput.click());
            compressBtn.addEventListener('click', compressImage);
            analyzeBtn.addEventListener('click', analyzeImage);
            copyReportBtn.addEventListener('click', copyReport);
            
            // أحداث الكاميرا الجديدة
            cameraBtn.addEventListener('click', openCamera);
            captureBtn.addEventListener('click', captureImage);
            retakeBtn.addEventListener('click', retakeImage);
            closeCameraBtn.addEventListener('click', closeCamera);
            
            // تحديد نوع التحليل
            radioItems.forEach(item => {
                item.addEventListener('click', () => {
                    radioItems.forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    const radioInput = item.querySelector('input');
                    radioInput.checked = true;
                });
            });
            
            // تحديد أول عنصر افتراضيًا
            radioItems[0].classList.add('selected');
            
            // التحقق من دعم الكاميرا
            checkCameraSupport();
        }
        
        // التحقق من دعم الكاميرا
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraBtn.disabled = true;
                cameraBtn.title = "الكاميرا غير مدعومة في متصفحك";
                showToast('الكاميرا غير مدعومة في متصفحك', 'error');
            }
        }
        
        // معالجة اختيار الملف
        function handleFileSelect(e) {
            const file = e.target.files[0];
            processFile(file);
        }
        
        // معالجة سحب الملف وإفلاته
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            processFile(file);
        }
        
        // معالجة الملف بعد اختياره
        function processFile(file) {
            if (file) {
                // التحقق من نوع الملف
                const validTypes = ['image/jpeg', 'image/png', 'application/dicom', 'application/pdf'];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const validExtensions = ['jpg', 'jpeg', 'png', 'dicom', 'dcm', 'pdf'];
                
                if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                    showToast('نوع الملف غير مدعوم. الرجاء تحميل صورة JPEG أو PNG أو DICOM أو PDF.', 'error');
                    return;
                }
                
                uploadedFile = file;
                originalSize = file.size;
                fileName.textContent = `تم اختيار: ${file.name} (${formatFileSize(file.size)})`;
                fileName.style.display = 'block';
                compressBtn.disabled = false;
                analyzeBtn.disabled = false;
                
                // عرض معاينة للصورة إذا كانت صورة
                if (file.type.includes('image') && !file.type.includes('dicom')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.style.display = 'none';
                }
                
                // إخفاء معلومات الضغط السابقة
                compressionInfo.style.display = 'none';
                compressedFile = null;
                compressedSize = 0;
            }
        }
        
        // إزالة تأثير السحب عند مغادرة المنطقة
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        // فتح الكاميرا
        async function openCamera() {
            try {
                cameraBtn.disabled = true;
                cameraBtn.innerHTML = 'جاري فتح الكاميرا... <span class="button-icon">⏳</span>';
                
                // استخدام الكاميرا الخلفية أولاً، إذا لم تكن متاحة استخدم الأمامية
                const constraints = {
                    video: { 
                        facingMode: usingFrontCamera ? 'user' : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }, 
                    audio: false 
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = stream;
                cameraPreview.style.display = 'block';
                captureBtn.style.display = 'block';
                closeCameraBtn.style.display = 'block';
                cameraBtn.style.display = 'none';
                
                // الانتظار حتى يتم تحميل بيانات الفيديو
                video.onloadedmetadata = function() {
                    // ضبط أبعاد canvas لتتناسب مع الفيديو
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
                
                cameraBtn.disabled = false;
                cameraBtn.innerHTML = 'فتح الكاميرا <span class="button-icon">📷</span>';
                
            } catch (error) {
                console.error('خطأ في الوصول إلى الكاميرا:', error);
                
                // محاولة استخدام الكاميرا الأمامية إذا فشلت الخلفية
                if (!usingFrontCamera) {
                    usingFrontCamera = true;
                    showToast('جاري المحاولة مع الكاميرا الأمامية...', 'info');
                    setTimeout(openCamera, 1000);
                } else {
                    showToast('تعذر الوصول إلى الكاميرا. يرجى التحقق من الأذونات.', 'error');
                    cameraBtn.disabled = false;
                    cameraBtn.innerHTML = 'فتح الكاميرا <span class="button-icon">📷</span>';
                }
            }
        }
        
        // التقاط صورة من الكاميرا
        function captureImage() {
            const context = canvas.getContext('2d');
            
            // ضمان أن أبعاد canvas مطابقة للفيديو
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // رسم الإطار الحالي من الفيديو على canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // تحويل canvas إلى صورة
            canvas.toBlob(function(blob) {
                const file = new File([blob], `صورة_كاميرا_${new Date().toISOString().replace(/:/g, '-')}.jpg`, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                processFile(file);
                
                // إخفاء عناصر الكاميرا وإظهار زر إعادة التقاط
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                video.style.display = 'none';
                canvas.style.display = 'block';
            }, 'image/jpeg', 0.9);
        }
        
        // إعادة التقاط الصورة
        function retakeImage() {
            video.style.display = 'block';
            canvas.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
        }
        
        // إغلاق الكاميرا
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            cameraPreview.style.display = 'none';
            cameraBtn.style.display = 'block';
            video.style.display = 'block';
            canvas.style.display = 'none';
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'none';
            closeCameraBtn.style.display = 'none';
            
            // إعادة تعيين إلى الكاميرا الخلفية للمرة القادمة
            usingFrontCamera = false;
        }
        
        // تقليص حجم الصورة
        function compressImage() {
            if (!uploadedFile || !uploadedFile.type.includes('image')) {
                showToast('تقليص الحجم متاح فقط لملفات الصور (JPEG, PNG)', 'error');
                return;
            }
            
            compressBtn.disabled = true;
            compressBtn.innerHTML = 'جاري التقليص... <span class="button-icon">⏳</span>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // تحديد الأبعاد الجديدة (تقليص إلى 80% من الحجم الأصلي)
                    const maxWidth = img.width * 0.8;
                    const maxHeight = img.height * 0.8;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = Math.round(height * maxWidth / width);
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = Math.round(width * maxHeight / height);
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // رسم الصورة على Canvas
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // تحويل إلى Blob بجودة مخفضة
                    canvas.toBlob(function(blob) {
                        compressedFile = new File([blob], uploadedFile.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        
                        compressedSize = blob.size;
                        const compressionRatio = Math.round((1 - (compressedSize / originalSize)) * 100);
                        
                        // عرض معلومات الضغط
                        compressionInfo.innerHTML = `
                            <strong>تم تقليص حجم الصورة:</strong><br>
                            الحجم الأصلي: ${formatFileSize(originalSize)}<br>
                            الحصر بعد الضغط: ${formatFileSize(compressedSize)}<br>
                            نسبة التوفير: ${compressionRatio}%
                        `;
                        compressionInfo.style.display = 'block';
                        
                        // تحديث المعاينة
                        imagePreview.src = URL.createObjectURL(blob);
                        
                        showToast(`تم تقليص حجم الصورة بنسبة ${compressionRatio}%`, 'success');
                        
                        compressBtn.disabled = false;
                        compressBtn.innerHTML = 'تقليص حجم الصورة <span class="button-icon">📁</span>';
                    }, 'image/jpeg', 0.7); // جودة 70%
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(uploadedFile);
        }
        
        // تحليل الصورة
        async function analyzeImage() {
            if (!uploadedFile) {
                showToast('يرجى اختيار ملف أولاً', 'error');
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = 'جاري التحليل... <span class="button-icon">⏳</span>';
            response.style.display = 'block';
            
            // عرض مؤشر التحميل
            analysisResult.innerHTML = `
                <div class="loading">
                    <span>جاري معالجة البيانات وتحليلها...</span>
                    <div class="spinner"></div>
                </div>
            `;

            try {
                // الحصول على نوع التحليل المحدد
                const selectedAnalysis = document.querySelector('input[name="analysisType"]:checked').value;
                
                // استخدام الملف المضغوط إذا كان متاحاً، وإلا استخدم الملف الأصلي
                const fileToUpload = compressedFile || uploadedFile;
                
                // رفع الملف إلى Puter
                const fileExtension = fileToUpload.name.split('.').pop();
                const puterFile = await puter.fs.write(`medical_data_${Date.now()}.${fileExtension}`, fileToUpload);
                const uploadedPath = puterFile.path;

                // إنشاء الـ prompt المناسب حسب نوع التحليل
                let promptText = '';
                
                switch(selectedAnalysis) {
                    case 'xray':
                        promptText = 'حلل صورة الأشعة السينية التالية وكأنك أخصائي أشعة متمرس. اتبع خطوات دقيقة: (1) صف الصورة من الناحية التقنية وجودتها، (2) حدد البنى التشريحية المرئية، (3) اذكر أي علامات غير طبيعية مثل الكسور، التكلسات، التهابات، أو تشوهات، (4) قدّم استنتاجاً طبياً منظمًا، (5) أنهِ بتوصية سريرية مبدئية مع التنويه بأن القرار النهائي يعود للطبيب المعالج.';
                        break;
                    case 'ct':
                        promptText = 'قم بتحليل صورة الأشعة المقطعية بدقة وكأنك استشاري أشعة. اعمل بالخطوات: (1) صف نوعية الصورة والمستوى المقطعي، (2) حدد الهياكل الطبيعية، (3) ابحث عن أي أورام، نزيف، إصابات، أو تشوهات، (4) اربط الملاحظات بتفسير سريري، (5) اختم باستنتاج شامل وتوصية بمتابعة الحالة مع الطبيب المختص.';
                        break;
                    case 'mri':
                        promptText = 'حلل صورة الرنين المغناطيسي بعناية تامة كاختصاصي أشعة. التزم بالتالي: (1) صف جودة وتتابعات التصوير، (2) عرّف البنى الطبيعية المرئية، (3) ابحث عن علامات غير طبيعية مثل إصابات الأربطة، التهابات، أورام، أو تشوهات، (4) قدّم تفسيراً سريرياً واضحاً، (5) اختتم باستنتاج منظم مع توصية للمتابعة الطبية التخصصية.';
                        break;
                    case 'ecg':
                        promptText = 'قم بتحليل تخطيط القلب (ECG) بدقة كطبيب قلب. اتبع الخطوات: (1) تحقق من معدل النبض والإيقاع، (2) حلل الموجات P و QRS و T، (3) ابحث عن أي علامات لاضطراب نظم، احتشاء، تضخم، أو مشاكل توصيل كهربائي، (4) قدم استنتاجاً طبياً منظماً، (5) اختم بتوصية لمراجعة الطبيب المختص لتأكيد النتائج.';
                        break;
                    case 'lab':
                        promptText = 'قم بتحليل نتائج التحاليل المخبرية كطبيب مختبر متخصص. اتبع الآتي: (1) اعرض كل فحص وقيمته مقارنة بالمعدل المرجعي، (2) أبرز القيم غير الطبيعية، (3) فسّر الدلالات المحتملة للانحرافات (مثل فقر الدم، العدوى، خلل وظائف الكبد أو الكلى)، (4) اربط النتائج بسياق سريري محتمل، (5) اختم بتوصية واضحة بمراجعة الطبيب المعالج لتكامل التشخيص.';
                        break;
                }

                // تحليل البيانات باستخدام الذكاء الاصطناعي
                const completion = await puter.ai.chat([
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'file',
                                puter_path: uploadedPath
                            },
                            {
                                type: 'text',
                                text: promptText
                            }
                        ]
                    }
                ], { model: 'gpt-5', stream: true });

                let text = '';

                // عرض النتيجة
                for await (const part of completion) {
                    if (part?.text) {
                        text += part.text;
                        analysisResult.innerHTML = formatAnalysisText(text);
                    }
                }

                // تنظيف الملف المؤقت
                await puter.fs.delete(uploadedPath);

            } catch (error) {
                analysisResult.innerHTML = `<strong>خطأ:</strong><br>${error.message}`;
            }

            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = 'بدء التحليل <span class="button-icon">⚕️</span>';
        }
        
        // نسخ التقرير
        function copyReport() {
            const reportText = analysisResult.innerText;
            navigator.clipboard.writeText(reportText)
                .then(() => {
                    showToast('تم نسخ التقرير إلى الحافظة', 'success');
                })
                .catch(err => {
                    showToast('فشل في نسخ التقرير', 'error');
                    console.error('Failed to copy: ', err);
                });
        }
        
        // تنسيق نص التحليل
        function formatAnalysisText(text) {
            // تحويل النص إلى فقرات وعناصر منظمة
            const sections = text.split(/\n\n+/);
            let formattedHTML = '';
            
            sections.forEach(section => {
                if (section.trim() !== '') {
                    // إذا كان العنوان الرئيسي
                    if (section.includes(':')) {
                        const parts = section.split(':');
                        formattedHTML += `<h4>${parts[0]}:</h4><p>${parts.slice(1).join(':')}</p>`;
                    } 
                    // إذا كانت قائمة
                    else if (section.includes('-')) {
                        const items = section.split('\n').filter(item => item.trim().startsWith('-'));
                        if (items.length > 0) {
                            formattedHTML += '<ul>';
                            items.forEach(item => {
                                formattedHTML += `<li>${item.replace('-', '').trim()}</li>`;
                            });
                            formattedHTML += '</ul>';
                        } else {
                            formattedHTML += `<p>${section}</p>`;
                        }
                    } 
                    // إذا كان فقرة عادية
                    else {
                        formattedHTML += `<p>${section}</p>`;
                    }
                }
            });
            
            return formattedHTML;
        }
        
        // عرض رسالة toast
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.style.background = type === 'success' ? 'var(--success)' : 'var(--accent)';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // تنسيق حجم الملف للعرض
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' بايت';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' كيلوبايت';
            else return (bytes / 1048576).toFixed(2) + ' ميجابايت';
        }
        
        // تهيئة التطبيق عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
